<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>카카오 모여라 - 만남 장소 추천</title>
    <style>
        /* ===== Base Reset ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background-color: #f5f7fa;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* ===== Design System Colors ===== */
        :root {
            --kakao-yellow: #FEE500;
            --kakao-yellow-hover: #F9D71C;
            --dark-text: #3C1E1E;
            --gray-bg: #F5F5F5;
            --gray-bg-2: #FAFAFA;
            --gray-text: #999;
            --gray-border: #E5E5E5;
            --blue-link: #1A8CFF;
            --green-success: #4CAF50;
            --green-bg: #E8F5E9;
            --avatar-yellow: #FFE812;
            --avatar-green: #A3D9A5;
            --avatar-pink: #FFB6C1;
            --avatar-blue: #B4D4E7;
            --chat-bg: #B2C7D9;
        }

        /* ===== Mobile App Container ===== */
        .mobile-app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* ===== Phase Indicator ===== */
        .phase-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid var(--gray-border);
        }

        .phase-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .phase-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 14px;
            left: calc(50% + 18px);
            width: calc(100% - 36px);
            height: 2px;
            background: var(--gray-border);
        }

        .phase-step.completed:not(:last-child)::after {
            background: var(--kakao-yellow);
        }

        .phase-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            background: var(--gray-border);
            color: var(--gray-text);
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .phase-step.active .phase-number {
            background: var(--dark-text);
            color: white;
        }

        .phase-step.completed .phase-number {
            background: var(--kakao-yellow);
            color: var(--dark-text);
        }

        .phase-label {
            font-size: 11px;
            color: var(--gray-text);
            font-weight: 500;
        }

        .phase-step.active .phase-label,
        .phase-step.completed .phase-label {
            color: var(--dark-text);
        }

        /* ===== Phase Container ===== */
        .phase-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .phase-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            visibility: hidden;
            overflow: hidden;
        }

        .phase-panel.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .phase-panel.prev {
            transform: translateX(-30%);
            opacity: 0;
        }

        /* ===== Common Components ===== */
        .phase-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
        }

        .phase-header .back-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--dark-text);
            opacity: 0.7;
            cursor: pointer;
        }

        .phase-header .title-area {
            flex: 1;
        }

        .phase-header .title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase-header .subtitle {
            font-size: 12px;
            color: var(--gray-text);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }

        .phase-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .phase-content.phase1-chat-bg {
            overflow: hidden;
        }

        .phase-footer {
            padding: 16px;
            background: white;
            border-top: 1px solid var(--gray-border);
        }

        /* ===== Buttons ===== */
        .btn-primary {
            width: 100%;
            height: 52px;
            background: var(--kakao-yellow);
            color: var(--dark-text);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--kakao-yellow-hover);
        }

        .btn-primary:disabled {
            background: var(--gray-bg);
            color: var(--gray-text);
            cursor: not-allowed;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            width: 100%;
            height: 52px;
            background: white;
            color: var(--dark-text);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-outline {
            height: 48px;
            padding: 0 20px;
            background: white;
            color: var(--dark-text);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* ===== Inputs ===== */
        .input-field {
            width: 100%;
            height: 48px;
            padding: 0 16px;
            background: var(--gray-bg);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            color: var(--dark-text);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            background: #EBEBEB;
        }

        .input-field::placeholder {
            color: var(--gray-text);
        }

        .textarea-field {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            background: var(--gray-bg);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            color: var(--dark-text);
            resize: none;
        }

        .textarea-field:focus {
            outline: none;
            background: #EBEBEB;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        /* ===== Tags ===== */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 14px;
            background: var(--gray-bg);
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 13px;
            color: var(--dark-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag.selected {
            background: var(--kakao-yellow);
            border-color: var(--kakao-yellow);
        }

        .tag:active {
            transform: scale(0.95);
        }

        .tag-small {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 12px;
        }

        /* ===== Avatar ===== */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .avatar-sm {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }

        .avatar-lg {
            width: 48px;
            height: 48px;
            font-size: 16px;
        }

        /* ===== Cards ===== */
        .card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .card-bordered {
            border: 1px solid var(--gray-border);
        }

        /* ===== Toast ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            background: var(--dark-text);
            color: white;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== Share Bottom Sheet ===== */
        .share-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .share-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .share-sheet {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            z-index: 2001;
            transition: transform 0.3s ease;
        }

        .share-overlay.active .share-sheet {
            transform: translateX(-50%) translateY(0);
        }

        .share-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--gray-border);
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .share-sheet-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
            text-align: center;
            margin-bottom: 20px;
        }

        .share-options {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 20px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .share-option-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .share-option-icon.kakao {
            background: var(--kakao-yellow);
        }

        .share-option-icon.copy {
            background: var(--gray-bg);
        }

        .share-option-icon.more {
            background: var(--gray-bg);
        }

        .share-option-label {
            font-size: 12px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .share-sheet-cancel {
            width: 100%;
            height: 48px;
            background: var(--gray-bg);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: var(--dark-text);
            cursor: pointer;
        }

        /* ===== Loading Overlay ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-bg);
            border-top-color: var(--kakao-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--gray-bg);
            border-radius: 2px;
            margin-top: 16px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--kakao-yellow);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* ===== Animations ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* ========================================
           PHASE 1: 약속생성 (카카오 채팅 스타일)
           ======================================== */
        .phase1-chat-bg {
            background: var(--chat-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .phase1-header {
            padding: 12px 16px;
            background: var(--chat-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .phase1-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .phase1-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase1-header-count {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.6;
        }

        .phase1-avatars {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            background: var(--chat-bg);
            flex-shrink: 0;
        }

        .phase1-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase1-chat-area {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            min-height: 0;
        }

        .phase1-date-badge {
            text-align: center;
            margin-bottom: 16px;
        }

        .phase1-date-badge span {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .phase1-card {
            max-width: 280px;
            margin: 0 auto 16px;
        }

        .phase1-card-header {
            background: var(--kakao-yellow);
            border-radius: 16px 16px 0 0;
            padding: 24px;
            text-align: center;
            position: relative;
        }

        .phase1-card-header::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 16px;
            height: 16px;
            background: var(--kakao-yellow);
        }

        .phase1-card-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .phase1-card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 4px;
        }

        .phase1-card-subtitle {
            font-size: 14px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .phase1-card-body {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 16px;
        }

        .phase1-card-body .input-field {
            margin-bottom: 12px;
        }

        .phase1-time-input {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-bg);
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 12px;
        }

        .phase1-time-input .time-icon {
            color: var(--gray-text);
            font-size: 16px;
        }

        .phase1-time-input input {
            width: 48px;
            height: 32px;
            text-align: center;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .phase1-time-input input:focus {
            outline: none;
        }

        .phase1-time-input .time-separator {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase1-chat-bubble {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            margin-bottom: 12px;
        }

        .phase1-chat-bubble .bubble-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase1-chat-bubble .bubble-content {
            max-width: 200px;
        }

        .phase1-chat-bubble .bubble-name {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.6;
            margin-bottom: 4px;
        }

        .phase1-chat-bubble .bubble-text {
            background: white;
            padding: 10px 14px;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            font-size: 14px;
            color: var(--dark-text);
        }

        .phase1-input-bar {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .phase1-input-bar input {
            flex: 1;
            height: 40px;
            padding: 0 16px;
            background: var(--gray-bg);
            border: none;
            border-radius: 20px;
            font-size: 14px;
        }

        .phase1-input-bar .send-btn {
            width: 40px;
            height: 40px;
            background: var(--kakao-yellow);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .phase1-input-bar .plus-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--dark-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: transform 0.3s ease;
        }

        .phase1-input-bar .plus-btn.active {
            transform: rotate(45deg);
        }

        /* Chat Menu (채팅 메뉴) */
        .chat-menu {
            background: white;
            border-top: 1px solid var(--gray-border);
            padding: 16px 12px;
            display: none;
            flex-shrink: 0;
        }

        .chat-menu.active {
            display: block;
        }

        .chat-menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px 4px;
        }

        .chat-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 8px 4px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .chat-menu-item:active {
            opacity: 0.7;
        }

        .chat-menu-icon {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .chat-menu-icon.yellow { background: #FEE500; }
        .chat-menu-icon.orange { background: #FF9500; }
        .chat-menu-icon.red { background: #FF3B30; }
        .chat-menu-icon.blue { background: #007AFF; }
        .chat-menu-icon.green { background: #34C759; }
        .chat-menu-icon.purple { background: #AF52DE; }
        .chat-menu-icon.gray { background: #8E8E93; color: white; }
        .chat-menu-icon.lightblue { background: #5AC8FA; }

        .chat-menu-label {
            font-size: 11px;
            color: var(--dark-text);
            font-weight: 500;
        }

        /* Result Bubble (채팅 말풍선 스타일 결과) */
        .result-bubble {
            align-items: flex-start !important;
        }

        .result-bubble .bubble-content {
            max-width: 280px;
        }

        .result-bubble-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .result-bubble-header {
            background: linear-gradient(135deg, var(--kakao-yellow), #FFD43B);
            padding: 14px;
            text-align: center;
        }

        .result-bubble-badge {
            display: inline-block;
            background: rgba(255,255,255,0.9);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 8px;
        }

        .result-bubble-place {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 2px;
        }

        .result-bubble-category {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .result-bubble-body {
            padding: 12px;
        }

        .result-bubble-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--dark-text);
            margin-bottom: 8px;
        }

        .result-bubble-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 10px 0;
        }

        .result-bubble-participants .participant-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--gray-bg);
            border-radius: 12px;
            font-size: 11px;
        }

        .result-bubble-participants .participant-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
        }

        .result-bubble-fairness {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            background: var(--green-bg);
            border-radius: 10px;
            font-size: 13px;
            color: #2E7D32;
            margin-bottom: 10px;
        }

        .result-bubble-fairness .fairness-score {
            font-size: 20px;
            font-weight: 700;
            color: var(--green-success);
        }

        .result-bubble-actions {
            display: flex;
            gap: 6px;
        }

        .result-bubble-actions button {
            flex: 1;
            height: 36px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--gray-bg);
            color: var(--dark-text);
        }

        .result-bubble-actions button:last-child {
            background: var(--kakao-yellow);
        }

        /* ========================================
           Result Chat View (결과 공유 채팅방)
           ======================================== */
        .result-chat-view {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: var(--chat-bg);
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .result-chat-view.active {
            display: flex;
        }

        .result-chat-header {
            flex-shrink: 0;
            padding: 12px 16px;
            background: var(--chat-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .result-chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .result-chat-back {
            font-size: 24px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .result-chat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .result-chat-count {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.6;
        }

        .result-chat-menu {
            font-size: 20px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .result-chat-avatars {
            flex-shrink: 0;
            display: flex;
            gap: 8px;
            padding: 8px 16px 16px;
            background: var(--chat-bg);
        }

        .result-chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .result-chat-messages {
            flex: 1 1 auto;
            padding: 16px;
            overflow-y: auto;
            min-height: 0;
        }

        .result-chat-date {
            text-align: center;
            margin-bottom: 16px;
        }

        .result-chat-date {
            display: inline-block;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.6;
            background: rgba(0,0,0,0.05);
            padding: 6px 12px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .result-chat-msg {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* 내 메시지 (오른쪽 정렬) */
        .result-chat-msg.my-msg {
            flex-direction: row-reverse;
        }

        .result-chat-msg.my-msg .msg-content {
            align-items: flex-end;
        }

        .result-chat-msg.my-msg .msg-result-card {
            border-radius: 16px;
            border-top-right-radius: 4px;
            border-top-left-radius: 16px;
        }

        .result-chat-msg.my-msg .msg-bubble {
            background: var(--kakao-yellow);
            border-radius: 16px;
            border-top-right-radius: 4px;
            border-top-left-radius: 16px;
        }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
            flex-shrink: 0;
        }

        .msg-content {
            max-width: 260px;
            display: flex;
            flex-direction: column;
        }

        .msg-name {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.6;
            margin-bottom: 4px;
        }

        .msg-bubble {
            background: white;
            padding: 10px 14px;
            border-radius: 16px;
            border-top-left-radius: 4px;
            font-size: 14px;
            color: var(--dark-text);
        }

        /* 결과 메시지 카드 */
        .msg-result-card {
            background: white;
            border-radius: 16px;
            border-top-left-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .msg-result-header {
            background: linear-gradient(135deg, var(--kakao-yellow), #FFD43B);
            padding: 14px;
            text-align: center;
        }

        .msg-result-badge {
            display: inline-block;
            background: rgba(255,255,255,0.9);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 8px;
        }

        .msg-result-place {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 2px;
        }

        .msg-result-category {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .msg-result-body {
            padding: 12px;
        }

        .msg-result-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--dark-text);
            margin-bottom: 6px;
        }

        .msg-result-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 10px 0;
        }

        .msg-result-participants .p-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--gray-bg);
            border-radius: 10px;
            font-size: 11px;
        }

        .msg-result-participants .p-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
        }

        .msg-result-fairness {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            background: var(--green-bg);
            border-radius: 10px;
            font-size: 13px;
            color: #2E7D32;
            margin-bottom: 10px;
        }

        .msg-result-fairness .fairness-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--green-success);
        }

        .msg-result-actions {
            display: flex;
            gap: 6px;
        }

        .msg-result-actions button {
            flex: 1;
            height: 36px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--gray-bg);
            color: var(--dark-text);
        }

        .msg-result-actions button:last-child {
            background: var(--kakao-yellow);
        }

        .result-chat-input {
            flex-shrink: 0;
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            background: white;
            border-top: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-chat-input input {
            flex: 1;
            height: 40px;
            padding: 0 16px;
            background: var(--gray-bg);
            border: none;
            border-radius: 20px;
            font-size: 14px;
        }

        .result-chat-input .send-btn {
            width: 40px;
            height: 40px;
            background: var(--kakao-yellow);
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .result-chat-input .plus-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--dark-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        /* ========================================
           PHASE 2: 정보입력
           ======================================== */
        .phase2-content {
            padding: 20px 16px;
        }

        .phase2-section {
            margin-bottom: 24px;
        }

        .phase2-section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 12px;
        }

        .phase2-location-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .phase2-location-row .input-field {
            flex: 1;
        }

        .phase2-location-row .search-btn {
            width: 60px;
            height: 48px;
            background: var(--kakao-yellow);
            color: var(--dark-text);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .phase2-gps-btn {
            width: 100%;
            height: 44px;
            background: none;
            border: none;
            color: var(--blue-link);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .phase2-share-btn {
            width: 36px;
            height: 36px;
            background: var(--kakao-yellow);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .phase2-share-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .phase2-share-btn:active {
            transform: scale(0.95);
        }

        .phase2-location-success {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--green-bg);
            border-radius: 12px;
            font-size: 14px;
            color: #2E7D32;
            margin-top: 8px;
        }

        .phase2-ai-btn {
            width: 100%;
            height: 52px;
            background: rgba(254, 229, 0, 0.2);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .phase2-ai-btn:hover {
            background: rgba(254, 229, 0, 0.3);
        }

        .phase2-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .phase2-filter-section {
            background: var(--gray-bg-2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .phase2-filter-category {
            margin-bottom: 16px;
        }

        .phase2-filter-category:last-child {
            margin-bottom: 0;
        }

        .phase2-filter-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .phase2-filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .phase2-detail-tag {
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            font-size: 12px;
            color: var(--dark-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .phase2-detail-tag.selected {
            background: var(--dark-text);
            color: white;
            border-color: var(--dark-text);
        }

        /* ========================================
           PHASE 3: 현황공유
           ======================================== */
        .phase3-header-section {
            padding: 20px 16px;
            border-bottom: 1px solid var(--gray-border);
        }

        .phase3-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .phase3-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase3-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .phase3-count .current {
            font-size: 24px;
            font-weight: 700;
            color: var(--kakao-yellow);
        }

        .phase3-count .separator {
            color: var(--gray-text);
        }

        .phase3-count .total {
            font-size: 18px;
            color: var(--gray-text);
        }

        .phase3-subtitle {
            font-size: 14px;
            color: var(--gray-text);
        }

        .phase3-progress {
            height: 6px;
            background: var(--gray-bg);
            border-radius: 3px;
            margin-top: 16px;
            overflow: hidden;
        }

        .phase3-progress-bar {
            height: 100%;
            background: var(--kakao-yellow);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .phase3-list {
            padding: 16px;
        }

        .phase3-participant-card {
            background: var(--gray-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: background 0.3s ease;
        }

        .phase3-participant-card.ready {
            background: var(--green-bg);
        }

        .phase3-participant-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .phase3-participant-info {
            flex: 1;
        }

        .phase3-participant-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phase3-participant-name .me-badge {
            color: var(--blue-link);
            font-size: 14px;
        }

        .phase3-check-badge {
            width: 20px;
            height: 20px;
            background: var(--green-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .phase3-participant-status {
            font-size: 13px;
            color: var(--green-success);
        }

        .phase3-participant-status.waiting {
            color: var(--gray-text);
        }

        .phase3-participant-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .phase3-participant-location {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .phase3-participant-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .phase3-participant-tag {
            padding: 4px 8px;
            background: white;
            border-radius: 12px;
            font-size: 11px;
            color: var(--dark-text);
        }

        .phase3-nudge-btn {
            padding: 6px 12px;
            background: var(--kakao-yellow);
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--dark-text);
            cursor: pointer;
        }

        .phase3-nudge-btn:disabled {
            background: var(--gray-bg);
            color: var(--gray-text);
        }

        /* ========================================
           PHASE 4: 결과확인
           ======================================== */
        .phase4-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-border);
        }

        .phase4-tab {
            flex: 1;
            padding: 14px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-text);
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .phase4-tab.active {
            color: var(--dark-text);
        }

        .phase4-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--kakao-yellow);
        }

        .phase4-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .phase4-tab-content.active {
            display: block;
        }

        /* 추천장소 탭 */
        .phase4-ai-banner {
            padding: 16px;
            background: rgba(254, 229, 0, 0.1);
            border-bottom: 1px solid var(--gray-border);
        }

        .phase4-ai-banner-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .phase4-ai-banner-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .phase4-ai-reason {
            margin: 12px 16px;
            padding: 16px;
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
            border-radius: 16px;
            border: 1px solid rgba(254, 229, 0, 0.3);
        }

        .ai-reason-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .ai-reason-icon {
            font-size: 20px;
        }

        .ai-reason-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .ai-reason-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }

        .ai-reason-content ul {
            margin: 0;
            padding-left: 20px;
        }

        .ai-reason-content li {
            margin-bottom: 6px;
        }

        .ai-reason-content li:last-child {
            margin-bottom: 0;
        }

        .ai-reason-highlight {
            color: var(--dark-text);
            font-weight: 600;
        }

        .phase4-place-list {
            padding: 0;
        }

        .phase4-place-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--gray-bg);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .phase4-place-item:hover,
        .phase4-place-item.selected {
            background: rgba(254, 229, 0, 0.1);
        }

        .phase4-place-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .phase4-place-rank.gold { background: #FFB800; }
        .phase4-place-rank.silver { background: #C0C0C0; }
        .phase4-place-rank.bronze { background: #CD7F32; }

        .phase4-place-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: var(--gray-bg);
            overflow: hidden;
            flex-shrink: 0;
        }

        .phase4-place-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .phase4-place-info {
            flex: 1;
            min-width: 0;
        }

        .phase4-place-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .phase4-place-price {
            font-size: 12px;
            color: var(--gray-text);
        }

        .phase4-place-category {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .phase4-place-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .phase4-place-rating .star {
            color: #FFB800;
        }

        .phase4-place-rating .score {
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase4-place-rating .count {
            color: var(--gray-text);
        }

        .phase4-place-rating .distance {
            color: var(--gray-text);
            margin-left: 8px;
        }

        .phase4-place-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .phase4-place-tag {
            padding: 2px 8px;
            background: var(--gray-bg);
            border-radius: 10px;
            font-size: 10px;
            color: #666;
        }

        .phase4-place-match {
            text-align: right;
            flex-shrink: 0;
        }

        .phase4-place-match-label {
            font-size: 11px;
            color: var(--gray-text);
        }

        .phase4-place-match-score {
            font-size: 18px;
            font-weight: 700;
            color: var(--kakao-yellow);
        }

        .phase4-place-detail {
            padding: 16px;
            background: var(--gray-bg-2);
            border-top: 1px solid var(--gray-border);
        }

        .phase4-place-address {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--dark-text);
            margin-bottom: 16px;
        }

        .phase4-travel-times {
            margin-bottom: 16px;
        }

        .phase4-travel-times-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .phase4-travel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-border);
            margin-bottom: 8px;
        }

        .phase4-travel-info {
            flex: 1;
        }

        .phase4-travel-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .phase4-travel-mode {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--gray-text);
            margin-top: 2px;
        }

        .phase4-travel-time {
            text-align: right;
        }

        .phase4-travel-time-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase4-travel-time-distance {
            font-size: 10px;
            color: var(--gray-text);
        }

        .phase4-action-btns {
            display: flex;
            gap: 8px;
        }

        .phase4-action-btns .btn-primary {
            flex: 1;
        }

        .phase4-action-btns .btn-icon {
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        /* 경로상세 탭 */
        .phase4-route-destination {
            padding: 16px;
            background: var(--kakao-yellow);
            margin: 16px;
            border-radius: 16px;
        }

        .phase4-route-destination-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .phase4-route-destination-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .phase4-route-destination-label {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .phase4-route-destination-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase4-route-destination-address {
            font-size: 12px;
            color: var(--dark-text);
            opacity: 0.7;
        }

        .phase4-route-list {
            padding: 0 16px 16px;
        }

        .phase4-route-card {
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .phase4-route-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
        }

        .phase4-route-header:hover {
            background: var(--gray-bg-2);
        }

        .phase4-route-info {
            flex: 1;
        }

        .phase4-route-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phase4-route-mode-badge {
            padding: 2px 8px;
            background: var(--gray-bg);
            border-radius: 10px;
            font-size: 10px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .phase4-route-origin {
            font-size: 12px;
            color: var(--gray-text);
        }

        .phase4-route-time {
            text-align: right;
        }

        .phase4-route-time-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase4-route-time-distance {
            font-size: 10px;
            color: var(--gray-text);
        }

        .phase4-route-expand-icon {
            color: var(--gray-text);
            font-size: 18px;
        }

        .phase4-route-detail {
            display: none;
            padding: 16px;
            border-top: 1px solid var(--gray-bg);
        }

        .phase4-route-detail.expanded {
            display: block;
        }

        .phase4-route-segment {
            display: flex;
            align-items: stretch;
        }

        .phase4-route-timeline {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 12px;
        }

        .phase4-route-segment-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .phase4-route-segment-icon.walk {
            background: var(--gray-border);
            color: #666;
        }

        .phase4-route-segment-icon.bus {
            background: #3CB44B;
            color: white;
        }

        .phase4-route-segment-icon.subway {
            color: white;
        }

        .phase4-route-segment-icon.car {
            background: #666;
            color: white;
        }

        .phase4-route-timeline-line {
            width: 2px;
            flex: 1;
            min-height: 20px;
            background: var(--gray-border);
        }

        .phase4-route-segment-info {
            flex: 1;
            padding-bottom: 12px;
        }

        .phase4-route-segment-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phase4-route-segment-time {
            font-size: 12px;
            color: var(--gray-text);
        }

        .phase4-route-segment-stations {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .phase4-route-segment-distance {
            font-size: 10px;
            color: var(--gray-text);
            margin-top: 2px;
        }

        .phase4-route-summary {
            margin: 0 16px 16px;
            padding: 16px;
            background: var(--gray-bg-2);
            border-radius: 12px;
        }

        .phase4-route-summary-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 12px;
        }

        .phase4-route-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }

        .phase4-route-summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-text);
        }

        .phase4-route-summary-value.highlight {
            color: var(--kakao-yellow);
        }

        .phase4-route-summary-label {
            font-size: 11px;
            color: var(--gray-text);
        }

        /* 공평도 탭 */
        .phase4-fairness-score {
            text-align: center;
            padding: 40px 20px;
        }

        .phase4-fairness-score-label {
            font-size: 14px;
            color: var(--gray-text);
            margin-bottom: 8px;
        }

        .phase4-fairness-score-value {
            font-size: 72px;
            font-weight: 700;
            color: var(--kakao-yellow);
            line-height: 1;
            position: relative;
            display: inline-block;
        }

        .phase4-fairness-score-max {
            position: absolute;
            top: 0;
            right: -40px;
            font-size: 14px;
            color: var(--gray-text);
        }

        .phase4-fairness-message {
            font-size: 15px;
            color: #666;
            margin-top: 12px;
        }

        .phase4-fairness-chart {
            margin: 0 16px;
            padding: 16px;
            background: var(--gray-bg-2);
            border-radius: 12px;
        }

        .phase4-fairness-chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 16px;
        }

        .phase4-fairness-bar-item {
            margin-bottom: 12px;
        }

        .phase4-fairness-bar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .phase4-fairness-bar-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phase4-fairness-bar-user .avatar {
            width: 24px;
            height: 24px;
            font-size: 10px;
        }

        .phase4-fairness-bar-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .phase4-fairness-bar-time {
            font-size: 13px;
            color: #666;
        }

        .phase4-fairness-bar-track {
            height: 8px;
            background: white;
            border-radius: 4px;
            overflow: hidden;
        }

        .phase4-fairness-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .phase4-fairness-explanation {
            margin: 16px;
            padding: 16px;
            background: rgba(254, 229, 0, 0.1);
            border-radius: 12px;
        }

        .phase4-fairness-explanation p {
            font-size: 14px;
            color: var(--dark-text);
            line-height: 1.6;
        }

        .phase4-bottom-actions {
            padding: 16px;
            border-top: 1px solid var(--gray-border);
        }

        .phase4-reset-btn {
            width: 100%;
            height: 48px;
            background: none;
            border: none;
            color: var(--gray-text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .phase4-reset-btn:hover {
            color: var(--dark-text);
        }

        /* ===== Map Container ===== */
        .map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            display: none;
        }

        .map-container.active {
            display: block;
        }

        .map-container #map {
            width: 100%;
            height: 100%;
        }

        .map-close-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 20px;
            cursor: pointer;
            z-index: 510;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">로딩 중...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loading-progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Share Bottom Sheet -->
    <div class="share-overlay" id="share-overlay" onclick="closeShareSheet()">
        <div class="share-sheet" onclick="event.stopPropagation()">
            <div class="share-sheet-handle"></div>
            <div class="share-sheet-title">공유하기</div>
            <div class="share-options">
                <button class="share-option" onclick="shareViaKakao()">
                    <div class="share-option-icon kakao">💬</div>
                    <span class="share-option-label">카카오톡</span>
                </button>
                <button class="share-option" onclick="shareViaCopyURL()">
                    <div class="share-option-icon copy">🔗</div>
                    <span class="share-option-label">링크 복사</span>
                </button>
                <button class="share-option" onclick="shareViaNative()">
                    <div class="share-option-icon more">📤</div>
                    <span class="share-option-label">더보기</span>
                </button>
            </div>
            <button class="share-sheet-cancel" onclick="closeShareSheet()">취소</button>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-container" id="map-container">
        <button class="map-close-btn" onclick="closeMap()">✕</button>
        <div id="map"></div>
    </div>

    <!-- Result Chat View (결과 공유용 채팅방 뷰) -->
    <div class="result-chat-view" id="result-chat-view">
        <div class="result-chat-header">
            <div class="result-chat-header-left">
                <span class="result-chat-back">‹</span>
                <div>
                    <div class="result-chat-title" id="result-chat-title">대학 동창 모임</div>
                    <div class="result-chat-count" id="result-chat-count">4</div>
                </div>
            </div>
            <span class="result-chat-menu">☰</span>
        </div>

        <div class="result-chat-avatars" id="result-chat-avatars">
            <div class="result-chat-avatar" style="background: var(--avatar-yellow);">노</div>
            <div class="result-chat-avatar" style="background: var(--avatar-green);">후</div>
            <div class="result-chat-avatar" style="background: var(--avatar-pink);">테</div>
            <div class="result-chat-avatar" style="background: var(--avatar-blue);">나</div>
        </div>

        <div class="result-chat-messages">
            <div class="result-chat-date" id="result-chat-date">2024년 1월 15일 월요일</div>

            <!-- 기존 채팅 메시지들 -->
            <div class="result-chat-msg">
                <div class="msg-avatar" style="background: var(--avatar-green);">후</div>
                <div class="msg-content">
                    <div class="msg-name">후니</div>
                    <div class="msg-bubble">장소 정했어? 😊</div>
                </div>
            </div>

            <div class="result-chat-msg">
                <div class="msg-avatar" style="background: var(--avatar-pink);">테</div>
                <div class="msg-content">
                    <div class="msg-name">테오</div>
                    <div class="msg-bubble">나도 궁금해~</div>
                </div>
            </div>

            <!-- 결과 말풍선 (내가 보낸 메시지 - 오른쪽 정렬) -->
            <div class="result-chat-msg my-msg">
                <div class="msg-content">
                    <div class="msg-result-card">
                        <div class="msg-result-header">
                            <div class="msg-result-badge">🏆 AI 추천 장소</div>
                            <div class="msg-result-place" id="rv-place-name">스타벅스 강남역점</div>
                            <div class="msg-result-category" id="rv-place-category">카페 · 강남구</div>
                        </div>
                        <div class="msg-result-body">
                            <div class="msg-result-info">
                                <span>📅</span>
                                <span id="rv-datetime">1월 24일 (금) 17:30</span>
                            </div>
                            <div class="msg-result-info">
                                <span>📍</span>
                                <span id="rv-address">서울 강남구 강남대로 396</span>
                            </div>
                            <div class="msg-result-participants" id="rv-participants"></div>
                            <div class="msg-result-fairness">
                                <span>공평도</span>
                                <span class="fairness-value" id="rv-fairness">88</span>
                                <span>점</span>
                            </div>
                            <div class="msg-result-actions">
                                <button onclick="openResultMapFromView()">🗺️ 지도보기</button>
                                <button onclick="shareFromResultView()">💬 공유하기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="result-chat-input">
            <button class="plus-btn">+</button>
            <input type="text" placeholder="메시지 입력" disabled>
            <button class="send-btn">#</button>
        </div>
    </div>

    <!-- Mobile App -->
    <div class="mobile-app">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" data-phase="1">
                <div class="phase-number">1</div>
                <div class="phase-label">약속 생성</div>
            </div>
            <div class="phase-step" data-phase="2">
                <div class="phase-number">2</div>
                <div class="phase-label">정보 입력</div>
            </div>
            <div class="phase-step" data-phase="3">
                <div class="phase-number">3</div>
                <div class="phase-label">현황 공유</div>
            </div>
            <div class="phase-step" data-phase="4">
                <div class="phase-number">4</div>
                <div class="phase-label">결과 확인</div>
            </div>
        </div>

        <!-- Phase Container -->
        <div class="phase-container">
            <!-- Phase 1: 약속생성 -->
            <div class="phase-panel active" id="phase-1">
                <div class="phase-content phase1-chat-bg">
                    <div class="phase1-header">
                        <div class="phase1-header-left">
                            <span style="font-size: 20px; opacity: 0.7;">‹</span>
                            <div>
                                <div class="phase1-header-title">대학 동창 모임</div>
                                <div class="phase1-header-count">4</div>
                            </div>
                        </div>
                        <span style="font-size: 20px; opacity: 0.7;">☰</span>
                    </div>

                    <div class="phase1-avatars">
                        <div class="phase1-avatar" style="background: var(--avatar-yellow);">노</div>
                        <div class="phase1-avatar" style="background: var(--avatar-green);">후</div>
                        <div class="phase1-avatar" style="background: var(--avatar-pink);">테</div>
                        <div class="phase1-avatar" style="background: var(--avatar-blue);">나</div>
                    </div>

                    <div class="phase1-chat-area">
                        <div class="phase1-date-badge">
                            <span id="today-date">2024년 1월 15일 월요일</span>
                        </div>

                        <!-- 채팅 말풍선들 (약속 잡기 전 대화) -->
                        <div class="phase1-chat-bubble">
                            <div class="bubble-avatar" style="background: var(--avatar-green);">후</div>
                            <div class="bubble-content">
                                <div class="bubble-name">후니</div>
                                <div class="bubble-text">우리 다음주에 만나자!</div>
                            </div>
                        </div>

                        <div class="phase1-chat-bubble">
                            <div class="bubble-avatar" style="background: var(--avatar-pink);">테</div>
                            <div class="bubble-content">
                                <div class="bubble-name">테오</div>
                                <div class="bubble-text">좋아~ 근데 어디서 볼까?</div>
                            </div>
                        </div>

                        <!-- 약속 생성 카드 (생성자용) - 채팅 이후에 나타남 -->
                        <div class="phase1-card" id="create-card" style="display: none;">
                            <div class="phase1-card-header">
                                <div class="phase1-card-icon">🐥</div>
                                <div class="phase1-card-title">카카오 모여라</div>
                                <div class="phase1-card-subtitle">우리 어디서 만날까요?</div>
                            </div>
                            <div class="phase1-card-body">
                                <input type="text" class="input-field" id="meeting-title" placeholder="약속 이름 (예: 동창 모임)">
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-text);">📅</span>
                                    <input type="date" class="input-field" id="meeting-date" style="padding-left: 40px;">
                                </div>
                                <div class="phase1-time-input">
                                    <span class="time-icon">🕐</span>
                                    <input type="text" id="meeting-hour" placeholder="00" maxlength="2" inputmode="numeric">
                                    <span class="time-separator">:</span>
                                    <input type="text" id="meeting-minute" placeholder="00" maxlength="2" inputmode="numeric">
                                </div>
                                <button class="btn-primary" id="create-meeting-btn" onclick="handleCreateMeeting()" disabled>약속 만들기</button>
                            </div>
                        </div>

                        <!-- 약속 참여 카드 (초대받은 사람용) -->
                        <div class="phase1-card" id="join-card" style="display: none;">
                            <div class="phase1-card-header">
                                <div class="phase1-card-icon">🎉</div>
                                <div class="phase1-card-title" id="join-meeting-title">약속에 초대되었어요!</div>
                                <div class="phase1-card-subtitle" id="join-meeting-info"></div>
                            </div>
                            <div class="phase1-card-body">
                                <div style="text-align: center; padding: 12px 0; color: var(--dark-text); font-size: 14px;">
                                    <p style="margin-bottom: 8px;">📍 중간 지점에서 만나요</p>
                                    <p style="color: var(--gray-text); font-size: 13px;">내 출발 위치를 입력하면<br>AI가 최적의 장소를 추천해드려요</p>
                                </div>
                                <button class="btn-primary" onclick="handleJoinMeeting()">참여하기</button>
                            </div>
                        </div>

                        <!-- 결과 공유 말풍선 (채팅 스타일) -->
                        <div class="phase1-chat-bubble result-bubble" id="result-card" style="display: none;">
                            <div class="bubble-avatar" style="background: var(--avatar-yellow);" id="result-creator-avatar">나</div>
                            <div class="bubble-content">
                                <div class="bubble-name" id="result-creator-name">나</div>
                                <div class="result-bubble-card">
                                    <div class="result-bubble-header">
                                        <div class="result-bubble-badge">🏆 AI 추천 장소</div>
                                        <div class="result-bubble-place" id="result-place-name">스타벅스 강남역점</div>
                                        <div class="result-bubble-category" id="result-place-category">카페 · 강남구</div>
                                    </div>
                                    <div class="result-bubble-body">
                                        <div class="result-bubble-info">
                                            <span>📅</span>
                                            <span id="result-datetime">1월 24일 (금) 17:30</span>
                                        </div>
                                        <div class="result-bubble-info">
                                            <span>📍</span>
                                            <span id="result-address">서울 강남구 강남대로 396</span>
                                        </div>
                                        <div class="result-bubble-participants" id="result-participants"></div>
                                        <div class="result-bubble-fairness">
                                            <span>공평도</span>
                                            <span class="fairness-score" id="result-fairness-score">88</span>
                                            <span>점</span>
                                        </div>
                                        <div class="result-bubble-actions">
                                            <button onclick="openResultMap()">🗺️ 지도보기</button>
                                            <button onclick="shareResult()">💬 공유하기</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Menu (채팅 메뉴) -->
                    <div class="chat-menu" id="chat-menu">
                        <div class="chat-menu-grid">
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon yellow">💰</div>
                                <span class="chat-menu-label">송금</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon red">🎮</div>
                                <span class="chat-menu-label">미니게임</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">📍</div>
                                <span class="chat-menu-label">지도</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon lightblue">👥</div>
                                <span class="chat-menu-label">친구위치</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon purple">🎵</div>
                                <span class="chat-menu-label">뮤직</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">📁</div>
                                <span class="chat-menu-label">파일</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">👤</div>
                                <span class="chat-menu-label">연락처</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon gray">🎙️</div>
                                <span class="chat-menu-label">음성메시지</span>
                            </button>
                            <button class="chat-menu-item" onclick="showMoyeoraCard()">
                                <div class="chat-menu-icon orange">🐥</div>
                                <span class="chat-menu-label">모여라</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">⏰</div>
                                <span class="chat-menu-label">예약메시지</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">📷</div>
                                <span class="chat-menu-label">캡쳐</span>
                            </button>
                            <button class="chat-menu-item">
                                <div class="chat-menu-icon blue">📅</div>
                                <span class="chat-menu-label">일정</span>
                            </button>
                        </div>
                    </div>

                    <div class="phase1-input-bar">
                        <button class="plus-btn" id="chat-menu-toggle" onclick="toggleChatMenu()">+</button>
                        <input type="text" placeholder="메시지 입력" disabled>
                        <button class="send-btn">#</button>
                    </div>
                </div>
            </div>

            <!-- Phase 2: 정보입력 -->
            <div class="phase-panel" id="phase-2">
                <div class="phase-header">
                    <button class="back-btn" onclick="goToPhase(1)">‹</button>
                    <div class="title-area">
                        <div class="title" id="phase2-meeting-title">해커톤</div>
                        <div class="subtitle">
                            <span id="phase2-meeting-date">📅 1월 24일</span>
                            <span id="phase2-meeting-time">🕐 17:30</span>
                        </div>
                    </div>
                    <button class="phase2-share-btn" onclick="shareToKakao()" title="카카오톡 공유">
                        💬
                    </button>
                </div>

                <div class="phase-content">
                    <div class="phase2-content">
                        <div class="phase2-section">
                            <div class="phase2-section-title">내 정보 입력</div>
                            <div class="input-group">
                                <input type="text" class="input-field" id="my-name" placeholder="이름 입력">
                            </div>
                            <div class="phase2-location-row">
                                <input type="text" class="input-field" id="my-location" placeholder="출발 위치 검색 (예: 강남역)" onkeydown="if(event.key==='Enter') searchMyLocation()">
                                <button class="search-btn" onclick="searchMyLocation()">검색</button>
                            </div>
                            <button class="phase2-gps-btn" onclick="getMyGPSLocation()">
                                <span>📍</span> 현재 위치로 설정
                            </button>
                            <div class="phase2-location-success" id="location-success" style="display: none;">
                                <span>✓</span>
                                <span id="location-success-text">위치가 설정되었습니다</span>
                            </div>
                        </div>

                        <div class="phase2-section">
                            <div class="phase2-section-title">상황 설명 (AI 분석용)</div>
                            <textarea class="textarea-field" id="context-input" placeholder="예: 나 오늘 차 가져가니까 주차 꼭 돼야 해! 아이도 데려갈 거야~"></textarea>
                            <button class="phase2-ai-btn" onclick="suggestConditions()" id="suggest-btn">
                                <span>✨</span>
                                <span id="suggest-btn-text">AI가 조건 추천해줄게요</span>
                            </button>
                        </div>

                        <div class="phase2-section" id="place-type-section" style="display: none;">
                            <div class="phase2-section-title">장소 유형</div>
                            <div class="phase2-tags" id="place-type-tags"></div>
                        </div>

                        <div class="phase2-section" id="detail-filter-section" style="display: none;">
                            <div class="phase2-section-title" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDetailFilters()">
                                <span>상세 조건 필터</span>
                                <span id="filter-toggle-icon">▼</span>
                            </div>
                            <div class="phase2-filter-section" id="detail-filters" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <div class="phase-footer">
                    <button class="btn-primary" id="submit-input-btn" onclick="handleSubmitInput()" disabled>입력 완료</button>
                </div>
            </div>

            <!-- Phase 3: 현황공유 -->
            <div class="phase-panel" id="phase-3">
                <div class="phase-content">
                    <div class="phase3-header-section">
                        <div class="phase3-header-row">
                            <div class="phase3-title">입력 현황</div>
                            <div class="phase3-count">
                                <span class="current" id="ready-count">0</span>
                                <span class="separator">/</span>
                                <span class="total" id="total-count">0</span>
                            </div>
                        </div>
                        <div class="phase3-subtitle">모두 입력하면 AI가 분석을 시작해요</div>
                        <div class="phase3-progress">
                            <div class="phase3-progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="phase3-list" id="participant-list"></div>
                </div>

                <div class="phase-footer">
                    <button class="btn-primary" id="find-meeting-btn" onclick="findMeetingPoint()" disabled>AI 장소 추천받기</button>
                </div>
            </div>

            <!-- Phase 4: 결과확인 -->
            <div class="phase-panel" id="phase-4">
                <div class="phase-header">
                    <button class="back-btn" onclick="goToPhase(3)">‹</button>
                    <div class="title-area">
                        <div class="title">추천 결과</div>
                    </div>
                </div>

                <div class="phase4-tabs">
                    <button class="phase4-tab active" data-tab="places" onclick="switchTab('places')">추천 장소</button>
                    <button class="phase4-tab" data-tab="routes" onclick="switchTab('routes')">경로 상세</button>
                    <button class="phase4-tab" data-tab="fairness" onclick="switchTab('fairness')">공평도</button>
                </div>

                <div class="phase-content">
                    <!-- 추천장소 탭 -->
                    <div class="phase4-tab-content active" id="tab-places">
                        <div class="phase4-ai-banner">
                            <div class="phase4-ai-banner-title">🏆 AI가 추천하는 장소</div>
                            <div class="phase4-ai-banner-subtitle">모든 참여자의 조건과 이동 시간을 고려했어요</div>
                        </div>
                        <div class="phase4-ai-reason" id="ai-reason">
                            <div class="ai-reason-header">
                                <span class="ai-reason-icon">🤖</span>
                                <span class="ai-reason-title">AI 추천 이유</span>
                            </div>
                            <div class="ai-reason-content" id="ai-reason-content">
                                <!-- JavaScript에서 동적으로 채워짐 -->
                            </div>
                        </div>
                        <div class="phase4-place-list" id="place-list"></div>
                        <div class="phase4-place-detail" id="place-detail" style="display: none;"></div>
                    </div>

                    <!-- 경로상세 탭 -->
                    <div class="phase4-tab-content" id="tab-routes">
                        <div class="phase4-route-destination" id="route-destination"></div>
                        <div class="phase4-route-list" id="route-list"></div>
                        <div class="phase4-route-summary" id="route-summary"></div>
                        <div style="padding: 0 16px;">
                            <button class="btn-outline" style="width: 100%;">
                                🚕 카카오T로 택시 호출하기
                            </button>
                        </div>
                    </div>

                    <!-- 공평도 탭 -->
                    <div class="phase4-tab-content" id="tab-fairness">
                        <div class="phase4-fairness-score" id="fairness-score"></div>
                        <div class="phase4-fairness-chart" id="fairness-chart"></div>
                        <div class="phase4-fairness-explanation" id="fairness-explanation"></div>
                    </div>
                </div>

                <div class="phase4-bottom-actions">
                    <button class="btn-secondary" onclick="shareResult()" style="margin-bottom: 8px;">
                        💬 오픈채팅에 공유하기
                    </button>
                    <button class="phase4-reset-btn" onclick="resetApp()">
                        ↺ 새로운 약속 만들기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b0d93c387f1ad6ca031e7229c0b51e16&libraries=services"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== API Keys & Config =====
        const GEMINI_API_KEY = 'AIzaSyDGWoqds0R57W2iEc3H_IPUA1EAcqC1IcA';
        const KAKAO_REST_API_KEY = '72abbb92306dab071780914b46e91435';
        const KAKAO_JS_KEY = 'b0d93c387f1ad6ca031e7229c0b51e16';
        const ODSAY_API_KEY = 'EE8Nj2+U8JACalNxKlZn3Q';
        const SUPABASE_URL = 'https://zlnyjzpuvibnenqefiyy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsbnlqenB1dmlibmVucWVmaXl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjU3MDUsImV4cCI6MjA4Mzk0MTcwNX0.2nRAWqEukgrTsGG87dRfaCDrt5Jd9anG623E52Lep6Y';

        // ===== App State =====
        const AppState = {
            currentPhase: 1,
            meetingSession: null,
            sessionId: null,
            myInfo: {
                name: '',
                location: '',
                lat: 0,
                lng: 0,
                context: '',
                conditions: []
            },
            selectedPlaceTypes: [],
            selectedDetailConditions: [],
            participants: [],
            results: [],
            selectedPlace: null
        };

        // ===== Dummy Test Data (이미 3명이 등록된 상태) =====
        const dummyParticipants = [
            {
                name: '후니',
                location: '홍대입구역',
                lat: 37.556980,
                lng: 126.923650,
                travelTime: 35,
                conditions: ['조용한 대화', '카페'],
                isReady: true
            },
            {
                name: '테오',
                location: '잠실역',
                lat: 37.513282,
                lng: 127.100167,
                travelTime: 40,
                conditions: ['웰컴키즈존'],
                isReady: true
            },
            {
                name: '나인',
                location: '신촌역',
                lat: 37.555134,
                lng: 126.936893,
                travelTime: 30,
                conditions: ['주차', '룸'],
                isReady: true
            }
        ];

        const dummyResults = [
            {
                place_name: '투썸플레이스 강남파이낸스센터점',
                address_name: '서울 강남구 테헤란로 152',
                category_name: '카페',
                x: '127.032308',
                y: '37.500633',
                phone: '02-555-1234',
                matchRate: 95
            },
            {
                place_name: '스타벅스 강남역점',
                address_name: '서울 강남구 강남대로 396',
                category_name: '카페',
                x: '127.028331',
                y: '37.498112',
                phone: '02-555-5678',
                matchRate: 88
            },
            {
                place_name: '할리스 강남점',
                address_name: '서울 강남구 역삼동 825-1',
                category_name: '카페',
                x: '127.030456',
                y: '37.499821',
                phone: '02-555-9999',
                matchRate: 82
            }
        ];

        // ===== Kakao Map =====
        let map = null;
        let geocoder = null;
        let ps = null;
        let markers = [];
        let supabaseClient = null;

        // ===== Avatar Colors =====
        const avatarColors = ['#FFE812', '#A3D9A5', '#FFB6C1', '#B4D4E7', '#F5DEB3'];

        // ===== Place Types =====
        const placeTypeConditions = [
            { icon: '🍽️', keyword: '음식점', category: 'FD6' },
            { icon: '☕', keyword: '카페', category: 'CE7' },
            { icon: '🍺', keyword: '술집', category: 'FD6' },
            { icon: '🍖', keyword: '고기집', category: 'FD6' },
            { icon: '🍜', keyword: '면요리', category: 'FD6' },
            { icon: '🍣', keyword: '일식', category: 'FD6' }
        ];

        // ===== Detail Condition Categories =====
        const detailConditionCategories = [
            {
                id: 'accessibility',
                label: '🚗 편의/접근성',
                conditions: [
                    { id: 'parking', icon: '🅿️', label: '주차' },
                    { id: 'mechanical-parking', icon: '🚗', label: '기계식 주차' },
                    { id: 'valet', icon: '🎩', label: '발렛' }
                ]
            },
            {
                id: 'care',
                label: '👶 웰컴/케어',
                conditions: [
                    { id: 'kids', icon: '👶', label: '웰컴키즈존' },
                    { id: 'babychair', icon: '🪑', label: '유아의자' },
                    { id: 'diaper', icon: '🧷', label: '기저귀 교환대' }
                ]
            },
            {
                id: 'diet',
                label: '🍽️ 식성/메뉴',
                conditions: [
                    { id: 'vegan', icon: '🥗', label: '비건' },
                    { id: 'halal', icon: '🍖', label: '할랄' },
                    { id: 'glutenfree', icon: '🌾', label: '글루텐프리' }
                ]
            },
            {
                id: 'mood',
                label: '🥂 Mood',
                conditions: [
                    { id: 'room', icon: '🚪', label: '룸(Private)' },
                    { id: 'group', icon: '👥', label: '단체석' },
                    { id: 'quiet', icon: '🤫', label: '조용한 대화' }
                ]
            }
        ];

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set today's date
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', options);

            // Initialize Supabase
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase 연결 성공');
            }

            // Initialize Kakao SDK
            if (window.Kakao) {
                console.log('Kakao SDK 로드됨');
                console.log('Kakao.Share 존재:', !!Kakao.Share);
                if (!Kakao.isInitialized()) {
                    try {
                        Kakao.init(KAKAO_JS_KEY);
                        console.log('Kakao SDK 초기화 완료, 앱키:', KAKAO_JS_KEY);
                    } catch (e) {
                        console.error('Kakao SDK 초기화 실패:', e);
                    }
                } else {
                    console.log('Kakao SDK 이미 초기화됨');
                }
            } else {
                console.error('Kakao SDK 로드 실패');
            }

            // Initialize session from URL
            initSession();

            // Setup input listeners
            setupInputListeners();

            // Render initial UI
            renderPlaceTypeTags();
            renderDetailFilters();

            // 더미 참여자 데이터 로드 (테스트용 - 민지가 이미 등록된 상태)
            AppState.participants = [...dummyParticipants];
            console.log('더미 참여자 로드됨:', AppState.participants);
        }

        function initSession() {
            const urlParams = new URLSearchParams(window.location.search);
            AppState.sessionId = urlParams.get('session');
            const meetingTitle = urlParams.get('title');
            const meetingDate = urlParams.get('date');
            const meetingTime = urlParams.get('time');
            const mode = urlParams.get('mode');

            if (AppState.sessionId) {
                // 결과 공유 모드인 경우
                if (mode === 'result') {
                    AppState.isResultView = true;
                    const resultData = {
                        placeName: urlParams.get('place') || '',
                        address: urlParams.get('address') || '',
                        category: urlParams.get('category') || '',
                        date: meetingDate || '',
                        time: meetingTime || '',
                        lat: urlParams.get('lat') || '',
                        lng: urlParams.get('lng') || '',
                        fairness: urlParams.get('fairness') || '?',
                        participants: []
                    };

                    // 참여자 정보 파싱
                    const participantsParam = urlParams.get('participants');
                    if (participantsParam) {
                        try {
                            resultData.participants = JSON.parse(participantsParam);
                        } catch (e) {
                            console.error('참여자 정보 파싱 실패:', e);
                        }
                    }

                    AppState.meetingSession = {
                        id: AppState.sessionId,
                        title: meetingTitle || '약속',
                        date: meetingDate || '',
                        time: meetingTime || ''
                    };

                    showResultCard(resultData);
                    return;
                }

                // 세션 링크로 들어온 경우 - 참여 모드
                AppState.isJoining = true;

                // URL에서 약속 정보 가져오기
                if (meetingTitle) {
                    AppState.meetingSession = {
                        id: AppState.sessionId,
                        title: meetingTitle,
                        date: meetingDate || '',
                        time: meetingTime || ''
                    };

                    // 참여 카드 표시
                    showJoinCard();
                } else {
                    // 약속 정보 없으면 기본 참여 카드 표시
                    AppState.meetingSession = {
                        id: AppState.sessionId,
                        title: '약속',
                        date: '',
                        time: ''
                    };
                    showJoinCard();
                }
            } else {
                // 새로 시작 - 생성 모드
                AppState.sessionId = generateUUID();
                AppState.isJoining = false;
            }
        }

        function showJoinCard() {
            document.getElementById('create-card').style.display = 'none';
            document.getElementById('join-card').style.display = 'block';

            const session = AppState.meetingSession;
            document.getElementById('join-meeting-title').textContent = session.title;

            let info = '';
            if (session.date) {
                const dateObj = new Date(session.date);
                info += `📅 ${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일`;
            }
            if (session.time) {
                info += ` 🕐 ${session.time}`;
            }
            document.getElementById('join-meeting-info').textContent = info || '함께 만남 장소를 찾아봐요!';

            // Phase 2 헤더도 업데이트
            document.getElementById('phase2-meeting-title').textContent = session.title;
            if (session.date) {
                const dateObj = new Date(session.date);
                document.getElementById('phase2-meeting-date').textContent = `📅 ${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일`;
            }
            if (session.time) {
                document.getElementById('phase2-meeting-time').textContent = `🕐 ${session.time}`;
            }
        }

        function handleJoinMeeting() {
            showToast('약속에 참여합니다!');
            goToPhase(2);
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function setupInputListeners() {
            // Phase 1 inputs
            const titleInput = document.getElementById('meeting-title');
            const dateInput = document.getElementById('meeting-date');
            const hourInput = document.getElementById('meeting-hour');
            const minuteInput = document.getElementById('meeting-minute');

            [titleInput, dateInput, hourInput, minuteInput].forEach(input => {
                input.addEventListener('input', validatePhase1);
            });

            // Time input validation
            hourInput.addEventListener('input', function(e) {
                let val = e.target.value.replace(/\D/g, '');
                if (val && parseInt(val) > 23) val = '23';
                e.target.value = val.slice(0, 2);
            });

            minuteInput.addEventListener('input', function(e) {
                let val = e.target.value.replace(/\D/g, '');
                if (val && parseInt(val) > 59) val = '59';
                e.target.value = val.slice(0, 2);
            });

            // Phase 2 inputs
            const nameInput = document.getElementById('my-name');
            const locationInput = document.getElementById('my-location');

            [nameInput, locationInput].forEach(input => {
                input.addEventListener('input', validatePhase2);
            });
        }

        function validatePhase1() {
            const title = document.getElementById('meeting-title').value.trim();
            const date = document.getElementById('meeting-date').value;
            const hour = document.getElementById('meeting-hour').value;
            const minute = document.getElementById('meeting-minute').value;

            const isValid = title && date && hour && minute;
            document.getElementById('create-meeting-btn').disabled = !isValid;
        }

        function validatePhase2() {
            const name = document.getElementById('my-name').value.trim();
            const hasLocation = AppState.myInfo.lat !== 0;

            const isValid = name && hasLocation;
            document.getElementById('submit-input-btn').disabled = !isValid;
        }

        // ===== Chat Menu =====
        function toggleChatMenu() {
            const menu = document.getElementById('chat-menu');
            const toggleBtn = document.getElementById('chat-menu-toggle');

            menu.classList.toggle('active');
            toggleBtn.classList.toggle('active');
        }

        function showMoyeoraCard() {
            const createCard = document.getElementById('create-card');
            const chatMenu = document.getElementById('chat-menu');
            const toggleBtn = document.getElementById('chat-menu-toggle');

            // Show the create card
            createCard.style.display = 'block';

            // Close the menu
            chatMenu.classList.remove('active');
            toggleBtn.classList.remove('active');

            // Scroll to the card
            setTimeout(() => {
                createCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // ===== Phase Navigation =====
        function goToPhase(phase) {
            if (phase < 1 || phase > 4) return;

            const currentPanel = document.getElementById(`phase-${AppState.currentPhase}`);
            const nextPanel = document.getElementById(`phase-${phase}`);

            // Update phase indicator
            document.querySelectorAll('.phase-step').forEach((step, idx) => {
                const stepPhase = idx + 1;
                step.classList.remove('active', 'completed');
                if (stepPhase === phase) {
                    step.classList.add('active');
                } else if (stepPhase < phase) {
                    step.classList.add('completed');
                }
            });

            // Animate panels
            if (phase > AppState.currentPhase) {
                currentPanel.classList.remove('active');
                currentPanel.classList.add('prev');
                nextPanel.classList.add('active');
            } else {
                currentPanel.classList.remove('active');
                nextPanel.classList.remove('prev');
                nextPanel.classList.add('active');
            }

            setTimeout(() => {
                currentPanel.classList.remove('prev');
            }, 400);

            AppState.currentPhase = phase;
            onPhaseEnter(phase);
        }

        function onPhaseEnter(phase) {
            switch(phase) {
                case 3:
                    loadParticipants();
                    subscribeToChanges();
                    break;
                case 4:
                    renderResults();
                    break;
            }
        }

        // ===== Phase 1: Create Meeting =====
        function handleCreateMeeting() {
            const title = document.getElementById('meeting-title').value.trim();
            const date = document.getElementById('meeting-date').value;
            const hour = document.getElementById('meeting-hour').value.padStart(2, '0');
            const minute = document.getElementById('meeting-minute').value.padStart(2, '0');

            AppState.meetingSession = {
                id: AppState.sessionId,
                title,
                date,
                time: `${hour}:${minute}`
            };

            // Update URL with session and meeting info
            const shareURL = getShareURL();
            window.history.replaceState({}, '', shareURL);

            // Update Phase 2 header
            document.getElementById('phase2-meeting-title').textContent = title;
            const dateObj = new Date(date);
            document.getElementById('phase2-meeting-date').textContent = `📅 ${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일`;
            document.getElementById('phase2-meeting-time').textContent = `🕐 ${hour}:${minute}`;

            showToast('약속이 생성되었습니다!');
            goToPhase(2);
        }

        function getShareURL() {
            const session = AppState.meetingSession;
            const params = new URLSearchParams();
            params.set('session', AppState.sessionId);
            if (session && session.title) {
                params.set('title', session.title); // URLSearchParams가 자동으로 인코딩함
            }
            if (session && session.date) {
                params.set('date', session.date);
            }
            if (session && session.time) {
                params.set('time', session.time);
            }
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        // ===== Kakao Share =====
        // ===== Share Sheet =====
        let currentShareMode = 'invite'; // 'invite' or 'result'

        function shareToKakao() {
            currentShareMode = 'invite';
            openShareSheet();
        }

        function openShareSheet() {
            document.getElementById('share-overlay').classList.add('active');
        }

        function closeShareSheet() {
            document.getElementById('share-overlay').classList.remove('active');
        }

        function shareViaKakao() {
            closeShareSheet();

            const shareURL = currentShareMode === 'result' ? getResultShareURL() : getShareURL();
            const session = AppState.meetingSession;

            console.log('=== Kakao Share Debug ===');
            console.log('Kakao 객체:', window.Kakao);
            console.log('Kakao.isInitialized():', window.Kakao ? Kakao.isInitialized() : 'N/A');
            console.log('Share URL:', shareURL);

            // Kakao SDK가 없는 경우
            if (!window.Kakao) {
                console.error('Kakao SDK가 로드되지 않았습니다');
                showToast('⚠️ 카카오 SDK 로드 실패');
                copyToClipboard(shareURL);
                showToast('📋 링크가 복사되었습니다');
                return;
            }

            // Kakao SDK 초기화 확인 및 재시도
            if (!Kakao.isInitialized()) {
                console.log('Kakao SDK 초기화 시도...');
                try {
                    Kakao.init(KAKAO_JS_KEY);
                    console.log('Kakao SDK 초기화 성공');
                } catch (e) {
                    console.error('Kakao SDK 초기화 실패:', e);
                    showToast('⚠️ 카카오 SDK 초기화 실패');
                    copyToClipboard(shareURL);
                    showToast('📋 링크가 복사되었습니다');
                    return;
                }
            }

            const title = session?.title || '약속';
            const dateStr = session?.date ? new Date(session.date).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : '';
            const timeStr = session?.time || '';

            let description, buttonTitle;
            if (currentShareMode === 'result') {
                const place = AppState.selectedPlace || (AppState.results && AppState.results[0]);
                const placeName = place?.place_name || place?.name || '';
                description = placeName ? `📍 ${placeName}` : '모두에게 공평한 중간 지점이에요!';
                if (dateStr || timeStr) description += ` | ${dateStr} ${timeStr}`;
                buttonTitle = '결과 확인하기';
            } else {
                description = dateStr && timeStr ? `${dateStr} ${timeStr}` : '중간 지점에서 만나요!';
                buttonTitle = '지금 참여하기';
            }

            // 카카오 공유 전에 URL을 클립보드에 복사 (링크가 안 열릴 경우 대비)
            copyToClipboard(shareURL);

            const shareData = {
                objectType: 'feed',
                content: {
                    title: `📍 ${title}`,
                    description: description,
                    imageUrl: 'https://stalwart-liger-9e766d.netlify.app/share-image.png',
                    link: {
                        mobileWebUrl: shareURL,
                        webUrl: shareURL
                    }
                },
                buttons: [
                    {
                        title: buttonTitle,
                        link: {
                            mobileWebUrl: shareURL,
                            webUrl: shareURL
                        }
                    }
                ]
            };

            console.log('Share Data:', JSON.stringify(shareData, null, 2));

            try {
                Kakao.Share.sendDefault(shareData);
                console.log('Kakao.Share.sendDefault 호출 완료');
                showToast('📤 카카오톡 공유창 열기...');
            } catch (e) {
                console.error('Kakao 공유 실패:', e);
                showToast('⚠️ 카카오 공유 실패');
                copyToClipboard(shareURL);
                showToast('📋 링크가 복사되었습니다');
            }
        }

        function shareViaCopyURL() {
            closeShareSheet();
            const shareURL = currentShareMode === 'result' ? getResultShareURL() : getShareURL();
            copyToClipboard(shareURL);
            showToast('📋 링크가 복사되었습니다!');
        }

        function shareViaNative() {
            closeShareSheet();
            const shareURL = currentShareMode === 'result' ? getResultShareURL() : getShareURL();
            const session = AppState.meetingSession;
            const title = session?.title || '약속';

            if (navigator.share) {
                navigator.share({
                    title: `📍 ${title}`,
                    text: '중간 지점에서 만나요!',
                    url: shareURL
                }).catch(err => {
                    console.log('Native share cancelled:', err);
                });
            } else {
                // Native share가 지원되지 않으면 URL 복사
                copyToClipboard(shareURL);
                showToast('📋 링크가 복사되었습니다!');
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        // ===== Phase 2: Input Info =====
        function searchMyLocation() {
            const location = document.getElementById('my-location').value.trim();
            if (!location) return;

            if (!geocoder) {
                geocoder = new kakao.maps.services.Geocoder();
            }

            geocoder.addressSearch(location, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    setLocationData(parseFloat(result[0].y), parseFloat(result[0].x), result[0].address_name);
                } else {
                    // Try keyword search
                    if (!ps) ps = new kakao.maps.services.Places();
                    ps.keywordSearch(location, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            setLocationData(parseFloat(result[0].y), parseFloat(result[0].x), result[0].place_name);
                        } else {
                            showToast('위치를 찾을 수 없습니다');
                        }
                    });
                }
            });
        }

        function getMyGPSLocation() {
            if (!navigator.geolocation) {
                showToast('GPS를 지원하지 않습니다');
                return;
            }

            showToast('현재 위치를 가져오는 중...');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    if (!geocoder) {
                        geocoder = new kakao.maps.services.Geocoder();
                    }

                    geocoder.coord2Address(lng, lat, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const address = result[0].address.address_name;
                            document.getElementById('my-location').value = address;
                            setLocationData(lat, lng, address);
                        } else {
                            setLocationData(lat, lng, '현재 위치');
                        }
                    });
                },
                function(error) {
                    showToast('위치를 가져올 수 없습니다');
                }
            );
        }

        function setLocationData(lat, lng, address) {
            AppState.myInfo.lat = lat;
            AppState.myInfo.lng = lng;
            AppState.myInfo.location = address;

            document.getElementById('my-location').value = address;
            document.getElementById('location-success').style.display = 'flex';
            document.getElementById('location-success-text').textContent = `위치가 설정되었습니다: ${address}`;

            validatePhase2();
            showToast('위치가 설정되었습니다');
        }

        async function suggestConditions() {
            const context = document.getElementById('context-input').value.trim();
            const btn = document.getElementById('suggest-btn');
            const btnText = document.getElementById('suggest-btn-text');

            if (!context) {
                showDefaultConditions();
                return;
            }

            btn.disabled = true;
            btnText.textContent = '분석 중...';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `사용자가 모임 상황을 설명했습니다: "${context}"

이 상황에 맞는 장소 유형과 조건을 추천해주세요. JSON 형식으로만 응답하세요:
{
  "placeTypes": ["음식점", "카페"],
  "conditions": ["주차", "단체석", "조용한 대화"]
}

가능한 placeTypes: 음식점, 카페, 술집, 고기집, 면요리, 일식
가능한 conditions: 주차, 기계식주차, 발렛, 웰컴키즈존, 유아의자, 기저귀 교환대, 비건, 할랄, 글루텐프리, 룸(Private), 단체석, 조용한 대화`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const jsonMatch = text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const suggestions = JSON.parse(jsonMatch[0]);

                    // Apply place type suggestions
                    if (suggestions.placeTypes) {
                        AppState.selectedPlaceTypes = placeTypeConditions.filter(p =>
                            suggestions.placeTypes.includes(p.keyword)
                        );
                    }

                    // Apply condition suggestions
                    if (suggestions.conditions) {
                        const allConditions = detailConditionCategories.flatMap(c => c.conditions);
                        AppState.selectedDetailConditions = allConditions
                            .filter(c => suggestions.conditions.some(s => c.label.includes(s) || s.includes(c.label)))
                            .map(c => c.id);
                    }
                }
            } catch (e) {
                console.error('AI 추천 오류:', e);
            }

            showDefaultConditions();
            btn.disabled = false;
            btnText.textContent = 'AI가 조건 추천해줄게요';
        }

        function showDefaultConditions() {
            document.getElementById('place-type-section').style.display = 'block';
            document.getElementById('detail-filter-section').style.display = 'block';

            if (AppState.selectedPlaceTypes.length === 0) {
                AppState.selectedPlaceTypes = [placeTypeConditions[0]];
            }

            renderPlaceTypeTags();
            renderDetailFilters();
        }

        function renderPlaceTypeTags() {
            const container = document.getElementById('place-type-tags');
            container.innerHTML = placeTypeConditions.map(p => {
                const isSelected = AppState.selectedPlaceTypes.some(s => s.keyword === p.keyword);
                return `<span class="tag ${isSelected ? 'selected' : ''}" onclick="togglePlaceType('${p.keyword}')">${p.icon} ${p.keyword}</span>`;
            }).join('');
        }

        function togglePlaceType(keyword) {
            const condition = placeTypeConditions.find(p => p.keyword === keyword);
            const idx = AppState.selectedPlaceTypes.findIndex(p => p.keyword === keyword);

            if (idx >= 0) {
                AppState.selectedPlaceTypes.splice(idx, 1);
            } else {
                AppState.selectedPlaceTypes.push(condition);
            }

            renderPlaceTypeTags();
        }

        function renderDetailFilters() {
            const container = document.getElementById('detail-filters');
            container.innerHTML = detailConditionCategories.map(cat => `
                <div class="phase2-filter-category">
                    <div class="phase2-filter-label">${cat.label}</div>
                    <div class="phase2-filter-tags">
                        ${cat.conditions.map(c => {
                            const isSelected = AppState.selectedDetailConditions.includes(c.id);
                            return `<span class="phase2-detail-tag ${isSelected ? 'selected' : ''}" onclick="toggleDetailCondition('${c.id}')">${c.icon} ${c.label}</span>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleDetailCondition(id) {
            const idx = AppState.selectedDetailConditions.indexOf(id);
            if (idx >= 0) {
                AppState.selectedDetailConditions.splice(idx, 1);
            } else {
                AppState.selectedDetailConditions.push(id);
            }
            renderDetailFilters();
        }

        function toggleDetailFilters() {
            const filters = document.getElementById('detail-filters');
            const icon = document.getElementById('filter-toggle-icon');
            if (filters.style.display === 'none') {
                filters.style.display = 'block';
                icon.textContent = '▲';
            } else {
                filters.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        async function handleSubmitInput() {
            const name = document.getElementById('my-name').value.trim();
            const context = document.getElementById('context-input').value.trim();

            AppState.myInfo.name = name;
            AppState.myInfo.context = context;
            AppState.myInfo.conditions = AppState.selectedDetailConditions.map(id => {
                const cond = detailConditionCategories.flatMap(c => c.conditions).find(c => c.id === id);
                return cond ? cond.label : id;
            });

            // Save to Supabase
            if (supabaseClient) {
                try {
                    await supabaseClient.from('participants').insert({
                        session_id: AppState.sessionId,
                        name: AppState.myInfo.name,
                        location: AppState.myInfo.location,
                        lat: AppState.myInfo.lat,
                        lng: AppState.myInfo.lng
                    });
                } catch (e) {
                    console.error('DB 저장 오류:', e);
                }
            }

            showToast('입력이 완료되었습니다!');
            goToPhase(3);
        }

        // ===== Phase 3: Sync =====
        async function loadParticipants() {
            if (!supabaseClient) {
                // Mock data for demo
                AppState.participants = [
                    { id: '1', name: AppState.myInfo.name || '노아', location: AppState.myInfo.location, lat: AppState.myInfo.lat, lng: AppState.myInfo.lng, isMe: true, isReady: true, conditions: AppState.myInfo.conditions },
                    { id: '2', name: '후니', location: '홍대입구역', lat: 37.556944, lng: 126.923917, isMe: false, isReady: true, conditions: ['주차'] },
                    { id: '3', name: '테오', location: '강남역', lat: 37.498095, lng: 127.02761, isMe: false, isReady: true, conditions: ['조용한 대화'] },
                    { id: '4', name: '나인', location: '신촌역', lat: 37.555178, lng: 126.936893, isMe: false, isReady: true, conditions: ['가성비'] }
                ];
                renderParticipants();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('participants')
                    .select('*')
                    .eq('session_id', AppState.sessionId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                AppState.participants = data.map(p => ({
                    id: p.id,
                    name: p.name,
                    location: p.location,
                    lat: p.lat,
                    lng: p.lng,
                    isMe: p.name === AppState.myInfo.name,
                    isReady: true,
                    conditions: []
                }));

                renderParticipants();
            } catch (e) {
                console.error('참여자 로드 오류:', e);
            }
        }

        function subscribeToChanges() {
            if (!supabaseClient) return;

            supabaseClient
                .channel(`participants:${AppState.sessionId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'participants',
                    filter: `session_id=eq.${AppState.sessionId}`
                }, (payload) => {
                    loadParticipants();
                })
                .subscribe();
        }

        function renderParticipants() {
            const container = document.getElementById('participant-list');
            const readyCount = AppState.participants.filter(p => p.isReady).length;
            const totalCount = AppState.participants.length;

            document.getElementById('ready-count').textContent = readyCount;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('progress-bar').style.width = `${(readyCount / Math.max(totalCount, 1)) * 100}%`;

            const allReady = readyCount >= 2;
            document.getElementById('find-meeting-btn').disabled = !allReady;
            document.getElementById('find-meeting-btn').textContent = allReady
                ? 'AI 장소 추천받기'
                : `${Math.max(2 - readyCount, 0)}명 더 필요해요`;

            container.innerHTML = AppState.participants.map((p, idx) => `
                <div class="phase3-participant-card ${p.isReady ? 'ready' : ''}">
                    <div class="phase3-participant-header">
                        <div class="avatar avatar-lg" style="background: ${avatarColors[idx % avatarColors.length]}">
                            ${p.name.charAt(0)}
                        </div>
                        <div class="phase3-participant-info">
                            <div class="phase3-participant-name">
                                ${p.name}
                                ${p.isMe ? '<span class="me-badge">(나)</span>' : ''}
                                ${p.isReady ? '<div class="phase3-check-badge">✓</div>' : ''}
                            </div>
                            <div class="phase3-participant-status ${p.isReady ? '' : 'waiting'}">
                                ${p.isReady ? '입력 완료' : '입력 대기 중...'}
                            </div>
                        </div>
                        ${!p.isReady && !p.isMe ? '<button class="phase3-nudge-btn">재촉하기</button>' : ''}
                    </div>
                    ${p.isReady && p.location ? `
                        <div class="phase3-participant-details">
                            <div class="phase3-participant-location">출발: ${p.location}</div>
                            ${p.conditions && p.conditions.length > 0 ? `
                                <div class="phase3-participant-tags">
                                    ${p.conditions.map(c => `<span class="phase3-participant-tag">${c}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ===== Phase 3 -> 4: Find Meeting Point =====
        async function findMeetingPoint() {
            const readyParticipants = AppState.participants.filter(p => p.isReady && p.lat);
            if (readyParticipants.length < 2) {
                showToast('최소 2명의 참여자가 필요합니다');
                return;
            }

            showLoading('참여자 위치를 확인하고 있어요', 0);

            // Calculate center point
            const centerLat = readyParticipants.reduce((sum, p) => sum + p.lat, 0) / readyParticipants.length;
            const centerLng = readyParticipants.reduce((sum, p) => sum + p.lng, 0) / readyParticipants.length;

            await delay(800);
            showLoading('주변 장소를 검색하고 있어요', 25);

            // Search places
            const keywords = AppState.selectedPlaceTypes.length > 0
                ? AppState.selectedPlaceTypes.map(p => p.keyword)
                : ['음식점'];

            let allResults = [];
            for (const keyword of keywords) {
                const results = await searchPlacesByKeyword(keyword, centerLat, centerLng);
                allResults = allResults.concat(results);
            }

            await delay(600);
            showLoading('이동 시간을 계산하고 있어요', 50);

            // Process results
            const processedResults = [];
            for (const place of allResults.slice(0, 5)) {
                const travelTimes = [];
                for (const p of readyParticipants) {
                    const distance = calculateDistance(p.lat, p.lng, parseFloat(place.y), parseFloat(place.x));
                    const time = estimateTransitTime(distance);
                    travelTimes.push({
                        name: p.name,
                        time,
                        distance: Math.round(distance * 1000),
                        lat: p.lat,
                        lng: p.lng,
                        transportMode: 'transit'
                    });
                }

                const avgTime = travelTimes.reduce((sum, t) => sum + t.time, 0) / travelTimes.length;
                const fairnessScore = calculateFairnessScore(travelTimes);

                processedResults.push({
                    id: place.id,
                    place_name: place.place_name,
                    category_name: place.category_name,
                    address_name: place.address_name || place.road_address_name,
                    lat: parseFloat(place.y),
                    lng: parseFloat(place.x),
                    travelTimes,
                    avgTime,
                    fairnessScore,
                    matchedConditions: AppState.selectedDetailConditions.slice(0, 3).map(id => {
                        const cond = detailConditionCategories.flatMap(c => c.conditions).find(c => c.id === id);
                        return cond ? cond.label : '';
                    }).filter(Boolean)
                });
            }

            await delay(600);
            showLoading('최적의 장소를 선정하고 있어요', 75);

            // Sort by fairness score
            processedResults.sort((a, b) => b.fairnessScore - a.fairnessScore);

            AppState.results = processedResults;
            AppState.selectedPlace = processedResults[0];

            await delay(400);
            hideLoading();

            showToast('추천 장소를 찾았습니다!');
            goToPhase(4);
        }

        function searchPlacesByKeyword(keyword, lat, lng) {
            return new Promise((resolve) => {
                if (!ps) ps = new kakao.maps.services.Places();

                ps.keywordSearch(keyword, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve(result.slice(0, 5));
                    } else {
                        resolve([]);
                    }
                }, {
                    location: new kakao.maps.LatLng(lat, lng),
                    radius: 5000,
                    sort: kakao.maps.services.SortBy.DISTANCE
                });
            });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function estimateTransitTime(distanceKm) {
            return Math.round(10 + (distanceKm / 22) * 60);
        }

        function calculateFairnessScore(travelTimes) {
            const times = travelTimes.map(t => t.time);
            const maxTime = Math.max(...times);
            const minTime = Math.min(...times);
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            if (avgTime === 0) return 100;
            return Math.max(0, Math.round(100 - ((maxTime - minTime) / avgTime) * 50));
        }

        // ===== Phase 4: Results =====
        function renderResults() {
            renderAiReason();
            renderPlaceList();
            renderRouteTab();
            renderFairnessTab();
        }

        function renderAiReason() {
            const container = document.getElementById('ai-reason-content');
            const participants = AppState.participants || [];
            const topPlace = AppState.results && AppState.results[0];

            if (!topPlace) {
                container.innerHTML = '<p>추천 결과를 분석 중입니다...</p>';
                return;
            }

            // 참여자들의 조건 수집
            const allConditions = [];
            participants.forEach(p => {
                if (p.conditions) {
                    allConditions.push(...p.conditions);
                }
            });

            // 조건 빈도 계산
            const conditionCounts = {};
            allConditions.forEach(c => {
                conditionCounts[c] = (conditionCounts[c] || 0) + 1;
            });

            // 가장 많이 선택된 조건들
            const topConditions = Object.entries(conditionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([cond, count]) => cond);

            // 평균 이동 시간 계산
            const avgTime = topPlace.travelTimes
                ? Math.round(topPlace.travelTimes.reduce((sum, t) => sum + t.time, 0) / topPlace.travelTimes.length)
                : 30;

            // 추천 이유 생성
            let reasons = [];

            reasons.push(`<span class="ai-reason-highlight">${participants.length}명</span>의 출발 위치를 분석하여 모두가 <span class="ai-reason-highlight">평균 ${avgTime}분</span> 내로 도착할 수 있는 중심 지역을 선정했어요.`);

            if (topConditions.length > 0) {
                reasons.push(`참여자들이 선호하는 조건인 <span class="ai-reason-highlight">${topConditions.join(', ')}</span>을(를) 만족하는 장소예요.`);
            }

            if (topPlace.matchedConditions && topPlace.matchedConditions.length > 0) {
                reasons.push(`이 장소는 <span class="ai-reason-highlight">${topPlace.matchedConditions.slice(0, 3).join(', ')}</span> 조건에 부합해요.`);
            }

            reasons.push(`공평도 점수 <span class="ai-reason-highlight">${topPlace.fairnessScore}%</span>로 모든 참여자에게 균형 잡힌 선택이에요.`);

            container.innerHTML = `
                <ul>
                    ${reasons.map(r => `<li>${r}</li>`).join('')}
                </ul>
            `;
        }

        function renderPlaceList() {
            const container = document.getElementById('place-list');
            container.innerHTML = AppState.results.map((place, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : 'bronze';
                const isSelected = AppState.selectedPlace && AppState.selectedPlace.id === place.id;

                return `
                    <div class="phase4-place-item ${isSelected ? 'selected' : ''}" onclick="selectPlace('${place.id}')">
                        <div class="phase4-place-rank ${rankClass}">${idx + 1}</div>
                        <div class="phase4-place-image">
                            <div style="width:100%;height:100%;background:linear-gradient(135deg,#f5f5f5,#e0e0e0);display:flex;align-items:center;justify-content:center;font-size:24px;">🍽️</div>
                        </div>
                        <div class="phase4-place-info">
                            <div class="phase4-place-name">
                                ${place.place_name}
                                <span class="phase4-place-price">$$</span>
                            </div>
                            <div class="phase4-place-category">${place.category_name || '음식점'}</div>
                            <div class="phase4-place-rating">
                                <span class="star">★</span>
                                <span class="score">4.${5 - idx}</span>
                                <span class="count">(${100 + idx * 50})</span>
                                <span class="distance">도보 ${3 + idx * 2}분</span>
                            </div>
                            <div class="phase4-place-tags">
                                ${place.matchedConditions.map(c => `<span class="phase4-place-tag">${c}</span>`).join('')}
                            </div>
                        </div>
                        <div class="phase4-place-match">
                            <div class="phase4-place-match-label">매칭</div>
                            <div class="phase4-place-match-score">${place.fairnessScore}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            renderPlaceDetail();
        }

        function selectPlace(placeId) {
            AppState.selectedPlace = AppState.results.find(p => p.id === placeId);
            renderPlaceList();
            renderRouteTab();
            renderFairnessTab();
        }

        function renderPlaceDetail() {
            const container = document.getElementById('place-detail');
            const place = AppState.selectedPlace;

            if (!place) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = `
                <div class="phase4-place-address">
                    📍 ${place.address_name}
                </div>
                <div class="phase4-travel-times">
                    <div class="phase4-travel-times-label">예상 이동시간</div>
                    ${place.travelTimes.map((t, idx) => `
                        <div class="phase4-travel-item">
                            <div class="avatar" style="background: ${avatarColors[idx % avatarColors.length]}">${t.name.charAt(0)}</div>
                            <div class="phase4-travel-info">
                                <div class="phase4-travel-name">${t.name}</div>
                                <div class="phase4-travel-mode">🚌 대중교통</div>
                            </div>
                            <div class="phase4-travel-time">
                                <div class="phase4-travel-time-value">${t.time}분</div>
                                <div class="phase4-travel-time-distance">${(t.distance / 1000).toFixed(1)}km</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="phase4-action-btns">
                    <button class="btn-primary" onclick="openMap()">🗺️ 지도에서 확인</button>
                    <button class="btn-icon">📞</button>
                    <button class="btn-icon">🧭</button>
                </div>
            `;
        }

        function renderRouteTab() {
            const place = AppState.selectedPlace;
            if (!place) return;

            // Destination
            document.getElementById('route-destination').innerHTML = `
                <div class="phase4-route-destination-row">
                    <div class="phase4-route-destination-icon">📍</div>
                    <div>
                        <div class="phase4-route-destination-label">목적지</div>
                        <div class="phase4-route-destination-name">${place.place_name}</div>
                        <div class="phase4-route-destination-address">${place.address_name}</div>
                    </div>
                </div>
            `;

            // Route list
            document.getElementById('route-list').innerHTML = `
                <p style="font-size:14px;font-weight:600;color:var(--dark-text);margin-bottom:12px;">참여자별 이동 경로</p>
                ${place.travelTimes.map((t, idx) => `
                    <div class="phase4-route-card">
                        <div class="phase4-route-header" onclick="toggleRouteDetail('route-detail-${idx}')">
                            <div class="avatar" style="background: ${avatarColors[idx % avatarColors.length]}">${t.name.charAt(0)}</div>
                            <div class="phase4-route-info">
                                <div class="phase4-route-name">
                                    ${t.name}
                                    <span class="phase4-route-mode-badge">🚌 대중교통</span>
                                </div>
                                <div class="phase4-route-origin">출발지</div>
                            </div>
                            <div class="phase4-route-time">
                                <div class="phase4-route-time-value">${t.time}분</div>
                                <div class="phase4-route-time-distance">${(t.distance / 1000).toFixed(1)}km</div>
                            </div>
                            <div class="phase4-route-expand-icon">▼</div>
                        </div>
                        <div class="phase4-route-detail" id="route-detail-${idx}">
                            <div class="phase4-route-segment">
                                <div class="phase4-route-timeline">
                                    <div class="phase4-route-segment-icon walk">🚶</div>
                                    <div class="phase4-route-timeline-line"></div>
                                </div>
                                <div class="phase4-route-segment-info">
                                    <div class="phase4-route-segment-name">도보 <span class="phase4-route-segment-time">${Math.round(t.time * 0.15)}분</span></div>
                                </div>
                            </div>
                            <div class="phase4-route-segment">
                                <div class="phase4-route-timeline">
                                    <div class="phase4-route-segment-icon subway" style="background:#00A84D;">🚇</div>
                                    <div class="phase4-route-timeline-line"></div>
                                </div>
                                <div class="phase4-route-segment-info">
                                    <div class="phase4-route-segment-name">지하철 2호선 <span class="phase4-route-segment-time">${Math.round(t.time * 0.7)}분</span></div>
                                    <div class="phase4-route-segment-stations">5개 정류장</div>
                                </div>
                            </div>
                            <div class="phase4-route-segment">
                                <div class="phase4-route-timeline">
                                    <div class="phase4-route-segment-icon walk">🚶</div>
                                </div>
                                <div class="phase4-route-segment-info">
                                    <div class="phase4-route-segment-name">도보 <span class="phase4-route-segment-time">${Math.round(t.time * 0.15)}분</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;

            // Summary
            const avgTime = Math.round(place.travelTimes.reduce((sum, t) => sum + t.time, 0) / place.travelTimes.length);
            const maxDiff = Math.max(...place.travelTimes.map(t => t.time)) - Math.min(...place.travelTimes.map(t => t.time));

            document.getElementById('route-summary').innerHTML = `
                <div class="phase4-route-summary-title">이동 요약</div>
                <div class="phase4-route-summary-grid">
                    <div>
                        <div class="phase4-route-summary-value">${avgTime}분</div>
                        <div class="phase4-route-summary-label">평균 이동시간</div>
                    </div>
                    <div>
                        <div class="phase4-route-summary-value">${maxDiff}분</div>
                        <div class="phase4-route-summary-label">최대 편차</div>
                    </div>
                    <div>
                        <div class="phase4-route-summary-value highlight">${place.fairnessScore}%</div>
                        <div class="phase4-route-summary-label">공평도</div>
                    </div>
                </div>
            `;
        }

        function toggleRouteDetail(id) {
            const detail = document.getElementById(id);
            detail.classList.toggle('expanded');
        }

        function renderFairnessTab() {
            const place = AppState.selectedPlace;
            if (!place) return;

            const avgTime = Math.round(place.travelTimes.reduce((sum, t) => sum + t.time, 0) / place.travelTimes.length);
            const maxTime = Math.max(...place.travelTimes.map(t => t.time));

            // Score
            document.getElementById('fairness-score').innerHTML = `
                <div class="phase4-fairness-score-label">공평도 점수</div>
                <div class="phase4-fairness-score-value">
                    ${place.fairnessScore}
                    <span class="phase4-fairness-score-max">/ 100</span>
                </div>
                <div class="phase4-fairness-message">모두가 만족할 수 있는 장소예요!</div>
            `;

            // Chart
            document.getElementById('fairness-chart').innerHTML = `
                <div class="phase4-fairness-chart-title">이동시간 비교</div>
                ${place.travelTimes.map((t, idx) => {
                    const percentage = (t.time / maxTime) * 100;
                    return `
                        <div class="phase4-fairness-bar-item">
                            <div class="phase4-fairness-bar-header">
                                <div class="phase4-fairness-bar-user">
                                    <div class="avatar" style="background: ${avatarColors[idx % avatarColors.length]}">${t.name.charAt(0)}</div>
                                    <span class="phase4-fairness-bar-name">${t.name}</span>
                                    <span style="color:var(--gray-text);font-size:12px;">🚌</span>
                                </div>
                                <span class="phase4-fairness-bar-time">${t.time}분</span>
                            </div>
                            <div class="phase4-fairness-bar-track">
                                <div class="phase4-fairness-bar-fill" style="width:${percentage}%;background:${avatarColors[idx % avatarColors.length]}"></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            // Explanation
            document.getElementById('fairness-explanation').innerHTML = `
                <p>모든 참여자의 이동 시간 편차가 적을수록 공평도 점수가 높아요. 이 장소는 평균 <strong>${avgTime}분</strong>이면 모두가 도착할 수 있어요!</p>
            `;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.phase4-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            document.querySelectorAll('.phase4-tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabId}`);
            });
        }

        // ===== Map =====
        function openMap() {
            const container = document.getElementById('map-container');
            container.classList.add('active');

            if (!map) {
                const mapDiv = document.getElementById('map');
                map = new kakao.maps.Map(mapDiv, {
                    center: new kakao.maps.LatLng(37.5665, 126.978),
                    level: 5
                });
            }

            // Clear existing markers
            markers.forEach(m => m.setMap(null));
            markers = [];

            const place = AppState.selectedPlace;
            if (place) {
                // Place marker
                const placeMarker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(place.lat, place.lng),
                    map: map
                });
                markers.push(placeMarker);

                // Participant markers
                AppState.participants.forEach((p, idx) => {
                    if (p.lat && p.lng) {
                        const marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(p.lat, p.lng),
                            map: map
                        });
                        markers.push(marker);
                    }
                });

                // Center on place
                map.setCenter(new kakao.maps.LatLng(place.lat, place.lng));
            }
        }

        function closeMap() {
            document.getElementById('map-container').classList.remove('active');
        }

        // ===== Utilities =====
        function showLoading(text, progress) {
            document.getElementById('loading-overlay').classList.add('active');
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-progress-bar').style.width = `${progress}%`;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function shareResult() {
            // 결과 채팅 뷰로 이동
            showResultChatView();
        }

        function showResultChatView() {
            const session = AppState.meetingSession;
            const place = AppState.selectedPlace || (AppState.results && AppState.results[0]);

            // 결과 데이터 구성
            const resultData = {
                placeName: place?.place_name || place?.name || '추천 장소',
                category: place?.category_name || '',
                address: place?.address_name || place?.address || '',
                date: session?.date || '',
                time: session?.time || '',
                lat: place?.y || place?.lat || '',
                lng: place?.x || place?.lng || '',
                fairness: calculateFairnessScore(),
                participants: AppState.participants.map(p => ({
                    n: p.name,
                    t: p.travelTime || 0
                }))
            };

            // 결과 채팅 뷰 표시
            showResultCard(resultData);
        }

        function getResultShareURL() {
            const session = AppState.meetingSession;
            const place = AppState.selectedPlace || (AppState.results && AppState.results[0]);
            const params = new URLSearchParams();

            params.set('session', AppState.sessionId);
            params.set('mode', 'result');

            if (session) {
                if (session.title) params.set('title', session.title);
                if (session.date) params.set('date', session.date);
                if (session.time) params.set('time', session.time);
            }

            if (place) {
                params.set('place', place.place_name || place.name || '');
                params.set('address', place.address_name || place.address || '');
                params.set('category', place.category_name || '');
                if (place.x) params.set('lng', place.x);
                if (place.y) params.set('lat', place.y);
            }

            // 참여자 이동시간 정보 (간단히)
            if (AppState.participants && AppState.participants.length > 0) {
                const participantData = AppState.participants.map(p => ({
                    n: p.name,
                    t: p.travelTime || 0
                }));
                params.set('participants', encodeURIComponent(JSON.stringify(participantData)));
            }

            // 공평도 점수
            const fairness = calculateFairnessScore();
            params.set('fairness', fairness);

            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }


        function openResultMap() {
            const place = AppState.selectedPlace || (AppState.results && AppState.results[0]);
            if (place && (place.x || place.lng) && (place.y || place.lat)) {
                const lng = place.x || place.lng;
                const lat = place.y || place.lat;
                window.open(`https://map.kakao.com/link/map/${encodeURIComponent(place.place_name || place.name)},${lat},${lng}`, '_blank');
            } else {
                showToast('지도 정보가 없습니다');
            }
        }

        function showResultCard(resultData) {
            // 메인 앱 숨기기
            document.querySelector('.mobile-app').style.display = 'none';

            // 결과 채팅 뷰 표시
            const resultView = document.getElementById('result-chat-view');
            resultView.classList.add('active');

            // 채팅방 제목 설정
            const title = AppState.meetingSession?.title || '약속';
            document.getElementById('result-chat-title').textContent = title;

            // 오늘 날짜 설정
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('result-chat-date').textContent = today.toLocaleDateString('ko-KR', options);

            // 참여자 수 설정
            const participantCount = resultData.participants?.length || 4;
            document.getElementById('result-chat-count').textContent = participantCount;

            // 아바타 업데이트
            if (resultData.participants && resultData.participants.length > 0) {
                const avatarsEl = document.getElementById('result-chat-avatars');
                avatarsEl.innerHTML = resultData.participants.map((p, i) => `
                    <div class="result-chat-avatar" style="background: ${avatarColors[i % avatarColors.length]};">
                        ${p.n ? p.n.charAt(0) : '?'}
                    </div>
                `).join('');
            }

            // 결과 데이터 표시
            document.getElementById('rv-place-name').textContent = resultData.placeName || '추천 장소';
            document.getElementById('rv-place-category').textContent = resultData.category || '';
            document.getElementById('rv-address').textContent = resultData.address || '';

            // 날짜/시간 표시
            let datetimeStr = '';
            if (resultData.date) {
                const dateObj = new Date(resultData.date);
                const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                datetimeStr = `${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일 (${weekdays[dateObj.getDay()]})`;
            }
            if (resultData.time) {
                datetimeStr += ` ${resultData.time}`;
            }
            document.getElementById('rv-datetime').textContent = datetimeStr || '일시 미정';

            // 참여자 이동시간 표시
            const participantsEl = document.getElementById('rv-participants');
            if (resultData.participants && resultData.participants.length > 0) {
                participantsEl.innerHTML = resultData.participants.map((p, i) => `
                    <div class="p-chip">
                        <div class="p-avatar" style="background: ${avatarColors[i % avatarColors.length]};">
                            ${p.n ? p.n.charAt(0) : '?'}
                        </div>
                        <span>${p.n || '?'} ${p.t || 0}분</span>
                    </div>
                `).join('');
            } else {
                participantsEl.innerHTML = '';
            }

            // 공평도 점수
            document.getElementById('rv-fairness').textContent = resultData.fairness || '?';

            // AppState에 결과 저장 (지도 열기용)
            AppState.selectedPlace = {
                place_name: resultData.placeName,
                address_name: resultData.address,
                x: resultData.lng,
                y: resultData.lat
            };

            // 메시지 영역 스크롤을 맨 아래로
            setTimeout(() => {
                const messagesArea = document.querySelector('.result-chat-messages');
                if (messagesArea) {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }
            }, 100);
        }

        // 결과 뷰에서 지도 열기
        function openResultMapFromView() {
            const place = AppState.selectedPlace;
            if (place && (place.x || place.lng) && (place.y || place.lat)) {
                const lng = place.x || place.lng;
                const lat = place.y || place.lat;
                window.open(`https://map.kakao.com/link/map/${encodeURIComponent(place.place_name || place.name)},${lat},${lng}`, '_blank');
            } else {
                showToast('지도 정보가 없습니다');
            }
        }

        // 결과 뷰에서 공유하기
        function shareFromResultView() {
            currentShareMode = 'result';
            openShareSheet();
        }

        function calculateFairnessScore() {
            if (!AppState.participants || AppState.participants.length < 2) return 85;

            const times = AppState.participants.map(p => p.travelTime || 30);
            const maxTime = Math.max(...times);
            const minTime = Math.min(...times);
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;

            if (maxTime === 0) return 100;

            const variance = times.reduce((sum, t) => sum + Math.pow(t - avgTime, 2), 0) / times.length;
            const stdDev = Math.sqrt(variance);
            const cv = avgTime > 0 ? (stdDev / avgTime) * 100 : 0;

            // CV가 낮을수록 공평함 (0% = 100점, 50% = 50점)
            const score = Math.max(0, Math.min(100, Math.round(100 - cv * 2)));
            return score;
        }

        function resetApp() {
            AppState.currentPhase = 1;
            AppState.meetingSession = null;
            AppState.myInfo = { name: '', location: '', lat: 0, lng: 0, context: '', conditions: [] };
            AppState.selectedPlaceTypes = [];
            AppState.selectedDetailConditions = [];
            AppState.participants = [];
            AppState.results = [];
            AppState.selectedPlace = null;

            // Reset UI
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-date').value = '';
            document.getElementById('meeting-hour').value = '';
            document.getElementById('meeting-minute').value = '';
            document.getElementById('my-name').value = '';
            document.getElementById('my-location').value = '';
            document.getElementById('context-input').value = '';
            document.getElementById('location-success').style.display = 'none';
            document.getElementById('place-type-section').style.display = 'none';
            document.getElementById('detail-filter-section').style.display = 'none';

            validatePhase1();
            goToPhase(1);
        }
    </script>
</body>
</html>
